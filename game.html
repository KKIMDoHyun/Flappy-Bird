<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>flappybird game</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

    var config = {
        type: Phaser.AUTO,
        width: 336,
        height: 483,
        physics: {
            default: 'arcade',
            arcade: {
                gravity: { y: 300 },
                debug: false
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };

    const assets = {
        pipe:{
            top: 'pipe-top',
            bottom: 'pipe-bottom'
        }
    }
    var bird;
    var platforms;
    var JumpKey;
    var gameOver;
    var gameStarted;
    var game = new Phaser.Game(config);
    var framesMove = 0;
    var player;
    var cursors;
    var space;
    var nextPipe;
    var currentPipe;
    function preload ()
    {
        //배경 및 땅
        this.load.image('background', 'images/1.png');
        this.load.spritesheet('ground', 'images/ground-sprite.png', {
            frameWidth: 336,
            frameHeight: 112
        });

        //시작화면
        this.load.image('Initial_Message', 'images/initial-message.png')

        //파이프
        this.load.image(assets.pipe.top, 'images/pipe-top.png');
        this.load.image(assets.pipe.bottom, 'images/pipe-bottom.png');

        //새
        this.load.spritesheet('bird', 'images/birdbird1.png', {
            frameWidth: 40,
            frameHeight: 29
        });
    
        //숫자
        this.load.image('number0', 'images/num0.bmp');
        this.load.image('number1', 'images/num1.bmp');
        this.load.image('number2', 'images/num2.bmp');
        this.load.image('number3', 'images/num3.bmp');
        this.load.image('number4', 'images/num4.bmp');
        this.load.image('number5', 'images/num5.bmp');
        this.load.image('number6', 'images/num6.bmp');
        this.load.image('number7', 'images/num7.bmp');
        this.load.image('number8', 'images/num8.bmp');
        this.load.image('number9', 'images/num9.bmp');

        //결과 화면
        this.load.image('gameOverCard', 'images/gameOver.png');
        this.load.image('restart', 'images/restart-button.png');
    }

    function create ()
    {
        background = this.add.image(168, 241, 'background').setInteractive();
        background.on('pointerdown', moveBird);

        gapsGroup = this.physics.add.group();
        pipe = this.physics.add.group();
        scrore = this.physics.add.staticGroup();
        
        ground = this.physics.add.sprite(168, 500, 'ground');
        ground.setCollideWorldBounds(true);
        ground.setDepth(10);

        Initial_Message = this.add.image(168, 161, 'Initial_Message');
        Initial_Message.setDepth(30);
        Initial_Message.visible = false;

        space = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
        
        //땅 움직임
        this.anims.create({
            key: 'ground-moving',
            frames: this.anims.generateFrameNumbers('ground', {
                start: 0,
                end: 2
            }),
            frameRate: 15,
            repeat: -1
        })
        this.anims.create({
            key: 'ground-stop',
            frames: [{
                key: 'ground',
                frame: 0
            }],
            frameRate: 20
        })
        
        //새 움직임
        this.anims.create({
            key: 'bird-fly',
            frames: this.anims.generateFrameNumbers('bird', { 
                start: 0, 
                end: 2 
            }),
            frameRate: 10,
            repeat: -1
        });
        this.anims.create({
            key: 'bird-stop',
            frames: [{
                key: 'bird',
                frame: 1
            }],
            frameRate: 20
        })

        PrepareGame(this);
        
        gameOverCard = this.add.image(168, 180, 'gameOverCard');
        gameOverCard.setDepth(20);
        gameOverCard.visible = false;

        restartButton = this.add.image(168, 250, 'restart').setInteractive();
        restartButton.setDepth(20);
        restartButton.visible = false;
        restartButton.on('pointerdown', restart);
        
    }

    function update (){
        if (gameOver || !gameStarted){
            return
        }
        if(framesMove > 0){
            framesMove--;
        }
        else if(Phaser.Input.Keyboard.JustDown(space)){
            moveBird();
        }
        else{
            //앵글 조정
        }
    
        pipe.children.iterate(function (child){
            if(child == undefined){
                return;
            }
            if(child.x < -50){
                child.destroy();
            }
            else{
                child.setVelocityX(-100);
            }
        })
        ////
        gapsGroup.children.iterate(function (child) {
            child.body.setVelocityX(-100)
        })
        ////
        nextPipe++;
        if(nextPipe == 130){
            makePipe(game.scene.scenes[0])
            nextPipe = 0;
        }
        
    }

    function PrepareGame(scene){
        framesMove = 0;
        gameOver = false;
        nextPipe = 0;
        currentPipe = assets.pipe;
        background.visible = true
        Initial_Message.visible = true;

        player = scene.physics.add.sprite(60, 200, 'bird');
        player.setCollideWorldBounds(true);
        player.anims.play('bird-fly', true);
        player.body.allowGravity = false;
        

        scene.physics.add.collider(player, ground, hitBird, null, scene)
        scene.physics.add.collider(player, pipe, hitBird, null, scene)

        ground.anims.play('ground-moving', true);

    }

    function moveBird(){
        if(gameOver){
            return
        }
        if (!gameStarted){
            startGame(game.scene.scenes[0])
        }
        player.setVelocityY(-350);
        player.angle = -15;
        framesMove = 6;
    }

    function hitBird(player){
        this.physics.pause();

        gameOver = true;
        gameStarted = false;

        player.anims.play('bird-stop');
        ground.anims.play('ground-stop');

        gameOverCard.visible = true;
        restartButton.visible = true;
    }

    function makePipe(scene){
        if (!gameStarted || gameOver){
            return
        }
        const pipeTopY = Phaser.Math.Between(-70, 120)
        // console.log(pipeTopY)
        // const gap = scene.add.line(336, pipeTopY + 210, 0, 0, 0, 98)
        // gapsGroup.add(gap)
        // gap.body.allowGravity = false
        // gap.visible = false

        const pipeTop = pipe.create(336, pipeTopY, currentPipe.top)
        pipeTop.body.allowGravity = false

        const pipeBottom = pipe.create(336, pipeTopY + 350, currentPipe.bottom)
        pipeBottom.body.allowGravity = false
    }
    
    function startGame(scene) {
        gameStarted = true
        Initial_Message.visible = false
        player.body.allowGravity = true;
        player.body.setGravityY(900);

        makePipe(scene);
    }

    function restart(){
        pipe.clear(true, true);
        gapsGroup.clear(true, true);
        player.destroy();
        gameOverCard.visible = false;
        restartButton.visible = false;

        PrepareGame(game.scene.scenes[0]);

        game.scene.scenes[0].physics.resume();
    }
</script>

</body>
</html>